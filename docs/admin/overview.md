# CHARLY Admin Panel Architecture\n\n## Overview\n\nThe CHARLY Admin Panel is a secure, RBAC-aware administrative interface built on top of the core C1a Admin API. It provides comprehensive tenant management, user administration, and system monitoring capabilities with military-grade security and tenant isolation.\n\n## Architecture Principles\n\n- **Security First**: All routes protected by RBAC guards with correlation ID tracking\n- **Tenant Isolation**: Complete separation between RESIDENTIAL and COMMERCIAL tenants\n- **Progressive Enhancement**: Mobile-responsive design with keyboard accessibility (WCAG AA)\n- **Performance**: Code-split routes with <100ms shell interactions\n- **Type Safety**: Full TypeScript coverage with runtime permission validation\n\n## Route Structure\n\n### Admin Route Namespace\n\nAll admin functionality lives under the `/admin` namespace:\n\n```\n/admin                  # Dashboard (overview and system status)\n/admin/tenants          # Tenant management (superadmin only)\n/admin/users            # User management (RBAC-scoped)\n/admin/rules/templates  # Rules template management\n/admin/audit/logs       # Audit log viewer (compliance)\n/admin/settings         # System configuration\n```\n\n### Route Protection\n\nEach route is protected by the `AdminGuard` component which:\n\n1. Verifies JWT authentication token\n2. Validates required permissions against user role\n3. Enforces tenant scope for tenant_admin users\n4. Provides RFC7807-compliant error responses\n\n```typescript\n// Example route protection\n<AdminGuard permissions={['admin:users:read']}>\n  <UsersPage />\n</AdminGuard>\n```\n\n## RBAC Permission System\n\n### Roles\n\n| Role | Description | Tenant Scope |\n|------|-------------|-------------|\n| `superadmin` | Full system access across all tenants | None (can switch) |\n| `tenant_admin` | Administrative access within assigned tenant | Fixed to tenant |\n| `auditor` | Read-only access for compliance monitoring | View-only access |\n\n### Permissions Matrix\n\n| Permission | Superadmin | Tenant Admin | Auditor |\n|------------|------------|-------------|----------|\n| `admin:tenants:read` | ✅ | ❌ | ✅ |\n| `admin:tenants:write` | ✅ | ❌ | ❌ |\n| `admin:users:read` | ✅ | ✅ | ✅ |\n| `admin:users:write` | ✅ | ✅ | ❌ |\n| `admin:roles:read` | ✅ | ❌ | ❌ |\n| `admin:roles:write` | ✅ | ❌ | ❌ |\n| `admin:templates:read` | ✅ | ✅ | ✅ |\n| `admin:templates:write` | ✅ | ✅ | ❌ |\n| `admin:integrations:read` | ✅ | ✅ | ✅ |\n| `admin:integrations:write` | ✅ | ✅ | ❌ |\n| `admin:audit:read` | ✅ | ✅ | ✅ |\n| `admin:system:read` | ✅ | ❌ | ✅ |\n\n### Permission Enforcement\n\nPermissions are enforced at multiple levels:\n\n1. **Route Level**: `AdminGuard` component blocks unauthorized access\n2. **Component Level**: UI elements hidden/disabled based on permissions\n3. **API Level**: Backend validates permissions on every request\n\n```typescript\n// Component-level permission enforcement\nconst canCreateUsers = hasPermission(adminUser, 'admin:users:write');\n\nreturn (\n  <div>\n    {canCreateUsers && (\n      <button onClick={createUser}>Create User</button>\n    )}\n  </div>\n);\n```\n\n## Component Architecture\n\n### Core Components\n\n#### AdminGuard\n- **Purpose**: Route-level RBAC enforcement\n- **Features**: JWT verification, permission validation, tenant scope checking\n- **Error Handling**: RFC7807-compliant error pages with retry functionality\n\n#### AdminLayout\n- **Purpose**: Main shell providing navigation and content structure\n- **Features**: Responsive sidebar, breadcrumbs, footer with admin context\n- **Accessibility**: Full keyboard navigation, ARIA labels, focus management\n\n#### Sidebar\n- **Purpose**: RBAC-aware navigation menu\n- **Features**: Permission-filtered menu items, active state management\n- **Responsive**: Collapsible on mobile with overlay backdrop\n\n#### Topbar\n- **Purpose**: Page header with tenant context and user actions\n- **Features**: Tenant switcher, notifications, user menu, correlation ID display\n- **Security**: Secure sign-out with token cleanup\n\n#### TenantSwitcher\n- **Purpose**: Tenant context management for superadmin\n- **Features**: Dropdown for superadmin, read-only display for others\n- **State Management**: URL parameter updates and custom events\n\n### Page Components\n\nAll admin pages follow consistent patterns:\n\n- **Header**: Page title, description, action buttons (permission-gated)\n- **Filters**: Context-aware filtering (tenant scope applied)\n- **Content**: Data tables/cards with loading/error states\n- **Actions**: Permission-based action availability\n\n## Security Features\n\n### Authentication\n- JWT token validation on every route access\n- Automatic token refresh handling\n- Secure sign-out with complete token cleanup\n\n### Authorization\n- Granular permission checking at component level\n- Tenant scope enforcement for multi-tenant isolation\n- API correlation ID tracking for audit trails\n\n### Data Protection\n- No sensitive data in client-side logs\n- Masked user IDs in UI (show first 8 chars only)\n- Secure error messages without information disclosure\n\n### Headers and Compliance\n- All API requests include `X-Correlation-ID` headers\n- RFC7807 Problem Details for error responses\n- Audit logging integration for compliance\n\n## Performance Optimizations\n\n### Code Splitting\n- Lazy-loaded admin pages using `React.lazy`\n- Suspense boundaries with loading states\n- Route-level code splitting for optimal bundle size\n\n### Caching Strategy\n- Component-level state caching\n- API response caching where appropriate\n- Tenant list caching for dropdown performance\n\n### Bundle Optimization\n- Tree-shaking for unused permissions\n- Shared components between admin pages\n- Minimal external dependencies\n\n## Testing Strategy\n\n### Test Coverage Areas\n\n1. **RBAC Tests** (`admin-shell.rbac.spec.tsx`)\n   - Permission matrix validation\n   - Role-based UI element visibility\n   - Tenant scope enforcement\n\n2. **Route Guard Tests** (`admin-guard.routes.spec.tsx`)\n   - Authentication flow testing\n   - Unauthorized access prevention\n   - Error state handling\n\n3. **Tenant Switcher Tests** (`tenant-switcher.spec.tsx`)\n   - Superadmin switching functionality\n   - Tenant admin scope display\n   - API error handling\n\n### Test Utilities\n\n```typescript\n// Mock admin user for testing\nconst mockAdminUser = {\n  id: 'test-admin',\n  email: 'admin@test.com',\n  role: 'superadmin',\n  permissions: ['admin:users:read']\n};\n\n// Test permission enforcement\nrender(\n  <AdminGuard permissions={['admin:users:read']}>\n    <TestComponent />\n  </AdminGuard>\n);\n```\n\n## Integration Points\n\n### Backend API Integration\n\nThe admin shell integrates with C1a Admin API endpoints:\n\n- `GET /api/admin/tenants` - Tenant information\n- `GET /api/admin/users` - User management\n- `GET /api/admin/rules/templates` - Template management\n- `GET /api/admin/audit/logs` - Audit log access\n- `POST /api/admin/verify` - Permission verification\n\n### Error Handling\n\nAll API integrations follow consistent error handling:\n\n```typescript\ntry {\n  const response = await fetch('/api/admin/users', {\n    headers: {\n      'Authorization': `Bearer ${token}`,\n      'X-Correlation-ID': generateCorrelationId()\n    }\n  });\n  \n  if (!response.ok) {\n    const error = await response.json();\n    // Handle RFC7807 error response\n  }\n} catch (error) {\n  // Handle network/parsing errors\n}\n```\n\n### State Management\n\n- React Context for admin user state\n- URL parameters for tenant context\n- Local state for UI interactions\n- Custom events for cross-component communication\n\n## Deployment Considerations\n\n### Environment Variables\n- `NODE_ENV`: Controls development features (correlation ID display)\n- Authentication endpoint configuration\n- API base URL configuration\n\n### Build Configuration\n- TypeScript strict mode enabled\n- Bundle analysis for performance monitoring\n- Source maps for production debugging\n\n### Security Headers\n- CSP (Content Security Policy) compliance\n- HSTS enforcement\n- Rate limiting integration\n\n## Future Enhancements\n\n### Phase C1c - Admin Users Console\n- Advanced user management features\n- Bulk user operations\n- Role assignment workflows\n\n### Phase C1d - System Monitoring\n- Real-time system metrics\n- Performance dashboards\n- Alert management\n\n### Phase C1e - Template Management\n- Visual template editor\n- Version control for templates\n- Template deployment workflows\n\n---\n\n## Development Guidelines\n\n### Adding New Admin Pages\n\n1. Create page component in `src/admin/pages/`\n2. Add route to `src/admin/routes.tsx` with required permissions\n3. Update sidebar navigation in `src/admin/components/Sidebar.tsx`\n4. Write comprehensive tests covering RBAC scenarios\n5. Update this documentation\n\n### Permission Changes\n\n1. Update permission types in `AdminGuard.tsx`\n2. Update role mappings in `ROLE_PERMISSIONS`\n3. Update backend permission validation\n4. Update tests and documentation\n\n### Testing New Features\n\n1. Write unit tests for components\n2. Write integration tests for RBAC scenarios\n3. Test across all three role types\n4. Verify tenant isolation\n5. Test error scenarios and edge cases\n\nThis architecture provides a secure, scalable foundation for CHARLY's administrative functions while maintaining the flexibility to evolve with future requirements."