<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Tax Appeal Packet - {{ property_data.address }}</title>
    <style>
        /* Print-friendly CSS styles */
        @page {
            size: A4;
            margin: 1in;
            @top-left {
                content: "{{ firm_name }}";
                font-size: 10px;
                color: #666;
            }
            @top-right {
                content: "Case: {{ case_number }}";
                font-size: 10px;
                color: #666;
            }
            @bottom-center {
                content: "Page " counter(page) " of " counter(pages);
                font-size: 10px;
                color: #666;
            }
        }
        
        body {
            font-family: 'Times New Roman', serif;
            font-size: 12px;
            line-height: 1.6;
            color: #333;
            max-width: 100%;
            margin: 0;
            padding: 0;
        }
        
        .page-break {
            page-break-before: always;
        }
        
        .header {
            text-align: center;
            border-bottom: 2px solid #333;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        
        .firm-logo {
            max-width: 200px;
            max-height: 80px;
            margin-bottom: 10px;
        }
        
        .firm-name {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .document-title {
            font-size: 18px;
            font-weight: bold;
            margin-top: 20px;
            text-transform: uppercase;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: bold;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
            margin-bottom: 15px;
            text-transform: uppercase;
        }
        
        .property-details-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        .property-details-table th,
        .property-details-table td {
            border: 1px solid #333;
            padding: 8px;
            text-align: left;
        }
        
        .property-details-table th {
            background-color: #f5f5f5;
            font-weight: bold;
        }
        
        .metrics-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        .metrics-table th,
        .metrics-table td {
            border: 1px solid #333;
            padding: 8px;
            text-align: right;
        }
        
        .metrics-table th {
            background-color: #f5f5f5;
            font-weight: bold;
            text-align: left;
        }
        
        .narrative-content {
            text-align: justify;
            margin-bottom: 20px;
        }
        
        .narrative-content h2,
        .narrative-content h3 {
            margin-top: 20px;
            margin-bottom: 10px;
        }
        
        .narrative-content p {
            margin-bottom: 12px;
        }
        
        .county-form {
            border: 2px solid #333;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #fafafa;
        }
        
        .signature-block {
            margin-top: 50px;
            text-align: left;
        }
        
        .signature-line {
            border-bottom: 1px solid #333;
            width: 300px;
            margin-bottom: 5px;
        }
        
        .exhibits-section {
            margin-top: 30px;
        }
        
        .exhibit-item {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            background-color: #f9f9f9;
        }
        
        .highlight {
            background-color: #ffff99;
            padding: 2px 4px;
        }
        
        .currency {
            font-weight: bold;
            color: #006400;
        }
        
        .percentage {
            font-weight: bold;
            color: #1e90ff;
        }
        
        .footer-info {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #333;
            font-size: 10px;
            color: #666;
        }
    </style>
</head>
<body>
    <!-- Header Section -->
    <div class="header">
        {% if firm_logo %}
            <img src="{{ firm_logo }}" alt="{{ firm_name }}" class="firm-logo">
        {% endif %}
        <div class="firm-name">{{ firm_name or "Tax Consulting Services" }}</div>
        <div class="document-title">Property Tax Appeal Packet</div>
        <div style="margin-top: 10px;">
            <strong>Property:</strong> {{ property_data.address or "Property Address" }}<br>
            <strong>Case Number:</strong> {{ case_number or "N/A" }}<br>
            <strong>Client:</strong> {{ client_name or "Property Owner" }}<br>
            <strong>Date:</strong> {{ generation_time }}
        </div>
    </div>

    <!-- Cover Letter / Narrative Section -->
    <div class="section">
        <div class="section-title">Executive Summary & Narrative</div>
        <div class="narrative-content">
            {% if narrative_html %}
                {{ narrative_html | safe }}
            {% else %}
                <p><strong>Property Tax Appeal Request</strong></p>
                <p>This document constitutes a formal appeal of the property tax assessment for the above-referenced property. Based on our comprehensive analysis, we respectfully request a reduction in the assessed value to reflect the true market value of the property.</p>
                <p>Our analysis includes market comparables, income approach calculations, and physical inspection findings that support our valuation conclusion.</p>
            {% endif %}
        </div>
    </div>

    <!-- Property Details Section -->
    <div class="section">
        <div class="section-title">Property Information</div>
        <table class="property-details-table">
            <tr>
                <th>Property Address</th>
                <td>{{ property_data.address or "Not specified" }}</td>
            </tr>
            <tr>
                <th>Property Identification Number (PIN)</th>
                <td>{{ property_data.pin or "Not specified" }}</td>
            </tr>
            <tr>
                <th>Owner</th>
                <td>{{ property_data.owner or client_name or "Not specified" }}</td>
            </tr>
            <tr>
                <th>Property Type</th>
                <td>{{ property_data.property_type or "Not specified" }}</td>
            </tr>
            <tr>
                <th>Year Built</th>
                <td>{{ property_data.year_built or "Not specified" }}</td>
            </tr>
            <tr>
                <th>Square Footage</th>
                <td>{{ "{:,}".format(property_data.square_footage) if property_data.square_footage else "Not specified" }}</td>
            </tr>
            <tr>
                <th>Current Assessment</th>
                <td class="currency">{{ format_currency(property_data.current_assessment) if property_data.current_assessment else "Not specified" }}</td>
            </tr>
            <tr>
                <th>Proposed Assessment</th>
                <td class="currency">{{ format_currency(property_data.proposed_assessment) if property_data.proposed_assessment else "Not specified" }}</td>
            </tr>
        </table>
    </div>

    <!-- Flagged Metrics Section -->
    {% if flagged_metrics %}
    <div class="section">
        <div class="section-title">Financial Analysis & Key Metrics</div>
        <table class="metrics-table">
            <tr>
                <th>Metric</th>
                <th>Value</th>
                <th>Analysis</th>
            </tr>
            {% if flagged_metrics.noi %}
            <tr>
                <td>Net Operating Income (NOI)</td>
                <td class="currency">{{ format_currency(flagged_metrics.noi) }}</td>
                <td>Annual income after operating expenses</td>
            </tr>
            {% endif %}
            {% if flagged_metrics.cap_rate %}
            <tr>
                <td>Capitalization Rate</td>
                <td class="percentage">{{ format_percentage(flagged_metrics.cap_rate * 100) }}</td>
                <td>Market-derived cap rate for valuation</td>
            </tr>
            {% endif %}
            {% if flagged_metrics.expense_ratio %}
            <tr>
                <td>Expense Ratio</td>
                <td class="percentage">{{ format_percentage(flagged_metrics.expense_ratio * 100) }}</td>
                <td>Operating expenses as % of gross income</td>
            </tr>
            {% endif %}
            {% if flagged_metrics.vacancy_rate %}
            <tr>
                <td>Vacancy Rate</td>
                <td class="percentage">{{ format_percentage(flagged_metrics.vacancy_rate * 100) }}</td>
                <td>Market vacancy allowance</td>
            </tr>
            {% endif %}
            {% if flagged_metrics.assessment_ratio %}
            <tr>
                <td>Assessment Ratio</td>
                <td class="percentage">{{ format_percentage(flagged_metrics.assessment_ratio * 100) }}</td>
                <td>Current assessment vs. market value</td>
            </tr>
            {% endif %}
            {% if flagged_metrics.market_value %}
            <tr>
                <td><strong>Concluded Market Value</strong></td>
                <td class="currency"><strong>{{ format_currency(flagged_metrics.market_value) }}</strong></td>
                <td><strong>Recommended assessment value</strong></td>
            </tr>
            {% endif %}
        </table>
    </div>
    {% endif %}

    <!-- Page Break before Forms -->
    <div class="page-break"></div>

    <!-- County Forms Section -->
    {% if forms_html %}
    <div class="section">
        <div class="section-title">Official County Forms</div>
        <div class="county-form">
            {{ forms_html | safe }}
        </div>
    </div>
    {% endif %}

    <!-- Signature Block -->
    <div class="section">
        <div class="section-title">Certification & Signature</div>
        {% if signature_block_html %}
            {{ signature_block_html | safe }}
        {% else %}
            <div class="signature-block">
                <p>I hereby certify that the information contained in this appeal is true and accurate to the best of my knowledge.</p>
                <br><br>
                <div class="signature-line"></div>
                <p><strong>Signature</strong></p>
                <br>
                <div class="signature-line"></div>
                <p><strong>Print Name</strong></p>
                <br>
                <div class="signature-line"></div>
                <p><strong>Date</strong></p>
                <br>
                <p><strong>Professional License:</strong> ________________</p>
            </div>
        {% endif %}
    </div>

    <!-- Exhibits Section -->
    {% if attachments %}
    <div class="page-break"></div>
    <div class="section exhibits-section">
        <div class="section-title">Exhibits & Supporting Documentation</div>
        {% for attachment in attachments %}
        <div class="exhibit-item">
            <strong>Exhibit {{ loop.index }}:</strong> {{ attachment.filename or "Supporting Document" }}<br>
            <em>{{ attachment.description or "No description provided" }}</em><br>
            {% if attachment.file_type %}
            <small>File Type: {{ attachment.file_type }}</small>
            {% endif %}
        </div>
        {% endfor %}
        <p><em>Note: Supporting documents are attached separately or follow this page.</em></p>
    </div>
    {% endif %}

    <!-- Footer Information -->
    <div class="footer-info">
        <p><strong>Generated by:</strong> CHARLY Property Tax Appeal System</p>
        <p><strong>Generation Time:</strong> {{ generation_time }}</p>
        <p><strong>Packet ID:</strong> {{ packet_id }}</p>
        <p><em>This document was generated electronically and may be subject to additional review and revision.</em></p>
    </div>
</body>
</html>